{% extends 'core/base.html' %} 
{% block title %}Order Queue{% endblock %}

{% block content %}
<h1 class="mb-4">ðŸ“‹ Active Order Queue</h1>
<p class="lead">View and update the status of all active customer orders.</p>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}


{% if active_orders %}
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Time Placed</th>
                <th>Items (Count)</th>
                <th>Total</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for order in active_orders %}
            <tr>
                <td>#{{ order.id }}</td>
                <td>
                    {% if order.student %}{{ order.student.user.username }} (Student)
                    {% elif order.faculty %}{{ order.faculty.user.username }} (Faculty)
                    {% elif order.staff and order.staff.user != request.user %}{{ order.staff.user.username }} (Staff)
                    {% else %}Anonymous{% endif %}
                </td>
                <td>{{ order.order_time|date:"H:i:s" }}</td>
                
                <td>{{ order.order_items.count|default:"N/A" }}</td>
                
                <td>TK{{ order.total_amount|floatformat:2 }}</td>
                
                <td>
                    {% if order.status == 'accepted' %}
                        <span class="badge bg-info">New Order</span>
                    {% elif order.status == 'preparing' %}
                        <span class="badge bg-warning text-dark">Preparing</span>
                    {% elif order.status == 'ready' %}
                        <span class="badge bg-success">Ready</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ order.get_status_display }}</span>
                    {% endif %}
                </td>
                
                <td>
                    <form method="POST" action="{% url 'manager_order_queue' %}" class="d-flex">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        
                        <select name="new_status" class="form-select form-select-sm me-2">
                            {% for status_key, status_value in status_choices %}
                                <option value="{{ status_key }}" {% if order.status == status_key %}selected{% endif %}>
                                    {{ status_value }}
                                </option>
                            {% endfor %}
                        </select>
                        
                        <button type="submit" class="btn btn-sm btn-primary">Update</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <div class="alert alert-success">
        <h4 class="alert-heading">Queue Clear!</h4>
        <p>There are currently no active or pending orders in the queue.</p>
    </div>
{% endif %}

<a href="{% url 'staff_dashboard' %}" class="btn btn-secondary mt-3">Back to Dashboard</a>
{% endblock content %}